#!/usr/bin/env bash

# Build and test all example solutions.
#
# We optimize by downloading and pre-compiling a shared set of package
# dependencies once. This requires all exercises to use the same package set,
# validated by scripts/ci-check.

set -u
set -o pipefail

base_dir=$(builtin cd "${BASH_SOURCE%/*}/.." || exit; pwd)
build_dir=${base_dir}/_build

# Pre-compile shared package dependencies
if [ -z "${CI+x}" ]; then
    # When running locally we want to start with a clean slate.
    if [ -d "${build_dir}" ]; then
        echo "Found existing ${build_dir}; removing..."
        rm -rf "${build_dir}"
    fi
fi

# We use the template exercise project as the source of truth for shared deps.
cp -R ./template "${build_dir}"
pushd "${build_dir}" > /dev/null || exit
echo "Fetching and compiling shared dependencies..."
npm install
npx spago install
popd > /dev/null || exit

# Iterate over each exercise and test its example/exemplar solution.
rc=0

for exercise_dir in ./exercises/{concept,practice}/*/; do
    exercise_dir="${exercise_dir%/}"
    slug=$(basename "${exercise_dir}")

    pushd "${exercise_dir}" > /dev/null || exit

    echo ""
    echo "Working in: ${exercise_dir}"
    echo ""

    # Link/copy pre-compiled dependencies (clean up any existing artifacts)
    if [[ -h .spago ]] || [[ -d .spago ]]; then
        rm -rf .spago
    fi
    ln -s "${build_dir}/.spago" .spago

    if [[ -e output ]]; then
        rm -rf output
    fi
    # Preserve timestamps so purs doesn't invalidate the cache.
    cp -R -p "${build_dir}/output" .

    if [[ -h node_modules ]] || [[ -d node_modules ]]; then
        rm -rf node_modules
    fi
    ln -s "${build_dir}/node_modules" node_modules

    # Copy example solution over the student stub for testing.
    # Practice exercises: copy examples/src/*.purs over src/*.purs
    # Concept exercises: copy .meta/Exemplar.purs over the single src/*.purs file
    if [[ "$exercise_dir" == ./exercises/practice/* ]]; then
        files=( examples/src/*.purs )
        if ! [[ -f ${files[0]} ]]; then
            echo "ERROR: No example solution found for practice exercise ${slug}"
            rc=1
            popd > /dev/null || exit
            continue
        fi
        cp examples/src/*.purs src/
    else
        if ! [[ -f ".meta/Exemplar.purs" ]]; then
            echo "ERROR: No exemplar solution found for concept exercise ${slug}"
            rc=1
            popd > /dev/null || exit
            continue
        fi
        src_file=( src/*.purs )
        cp ".meta/Exemplar.purs" "${src_file[0]}"
    fi

    # Build and test. We use --offline since packages are already cached
    # in .spago/. We don't use --pure because the lockfile has the template
    # package name, not this exercise's name.
    if ! npx spago test --offline; then
        rc=1
    fi

    popd > /dev/null || exit
done

exit $rc
